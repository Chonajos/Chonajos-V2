<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<ui:composition template="./../templates/main.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:o="http://omnifaces.org/ui">

    <ui:define name="content">
        <h:panelGroup id="script">
            <script >
                window.onload = function () {
                    if (navigator.geolocation) {
                        checkGeolocationByHTML5();

                    } else {
                        displayErrorMessage([{name: 'errorMsg', value: 'Sin soporte para geolocalización, actualize su navegador.'}]);
                    }

                    function checkGeolocationByHTML5() {

                        navigator.geolocation.getCurrentPosition(function (objPosicion) {
                            var inputLatitud = document.getElementById('formRegHorarios:inputLatitud').value = objPosicion.coords.latitude;
                            var inputLongitud = document.getElementById('formRegHorarios:inputLongitud').value = objPosicion.coords.longitude;

                            loadMap(inputLatitud, inputLongitud);

                        }, function (objError) {

                            var msg;
                            switch (objError.code) {
                                case objError.POSITION_UNAVAILABLE:
                                    msg = 'La información de su posición no está disponible.';
                                    break;
                                case objError.TIMEOUT:
                                    msg = 'El tiempo de espera para obtener la ubicación se ha agotado.';
                                    break;
                                case objError.PERMISSION_DENIED:
                                    msg = 'El usuario negó la solicitud de Geolocalización.';
                                    break;
                                case objError.UNKNOWN_ERROR:
                                    msg = 'Un error desconocido ocurrió.';
                                    break;
                            }
                            displayErrorMessage([{name: 'errorMsg', value: msg}]);
                        }, {enableHighAccuracy: false,
                            timeout: 10000,
                            maximumAge: 0});
                    }

                    function loadMap(latitude, longitude) {

                        var latlon = new google.maps.LatLng(latitude, longitude);

                        var myOptions = {
                            zoom: 16,
                            center: latlon,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };

                        var map = new google.maps.Map(document.getElementById('map_canvas'), myOptions);

                        var coorMarcador = new google.maps.LatLng(latitude, longitude);

                        new google.maps.Marker({
                            position: coorMarcador,
                            map: map,
                            icon: 'http://maps.google.com/mapfiles/ms/micons/blue-dot.png',
                            title: 'Ubicación actual'

                        });

                        var jsonString = document.getElementById('formRegHorarios:inputJsonUbicaciones').value;
                        var arrayJsonUbicaciones = JSON.parse(jsonString);

                        $.each(arrayJsonUbicaciones, function (idx, obj) {
                            var coord = new google.maps.LatLng(obj.ubiLatitud, obj.ubiLongitud);

                            new google.maps.Marker({
                                position: coord,
                                map: map,
                                title: obj.ubiNombre
                            });
                        });
                    }
                };
            </script>
        </h:panelGroup>

        <h:form id="formRegHorarios"  class="form-horizontal" >
            <p:remoteCommand  name="displayErrorMessage" actionListener="#{beanRegistroEntrada.showGeolocationMessage}" update="formRegHorarios" ignoreAutoUpdate="true"/>
            <p:ajaxStatus onsuccess="PF('statusDialog').hide()" />
            <p:dialog widgetVar="statusDialog" modal="true" draggable="false"
                      closable="false" resizable="false" showHeader="false">
                
            </p:dialog>
            <h1 class="page-header titulo">
                <h:outputText value="Registro de Hora" />
            </h1>
            <p:messages id="messages" showDetail="true" autoUpdate="true"  showSummary="false" closable="true" />
            <div class="btn-group" role="group" aria-label="First group ">	
                <p:commandButton  id="btnGuardar" value="Registrar Entrada" action="#{beanRegistroEntrada.insert()}" disabled="#{beanRegistroEntrada.permissionToEntrada}" >
                </p:commandButton>
                <p:commandButton  id="btnRefresh" value="Registrar Salida" action="#{beanRegistroEntrada.insert()}" disabled="#{beanRegistroEntrada.permisionToSalida}" >
                </p:commandButton>		
                <h:inputHidden  id="inputLatitud"  value="${beanRegistroEntrada.latitud}" 
                                class="inputHorarios" />
                <h:inputHidden  id="inputLongitud"  value="${beanRegistroEntrada.longitud}" 
                                class="inputHorarios" />
                <h:inputHidden  id="inputJsonUbicaciones"  value="{beanRegistroEntrada.jsonUbicaciones}" 
                                class="inputHorarios" />
            </div>	
            <p:panel styleClass="map-width noBorderPanel" >
                <div id="map_canvas" style="height: 300px;"></div> 
            </p:panel>
        </h:form>


    </ui:define>

</ui:composition>
